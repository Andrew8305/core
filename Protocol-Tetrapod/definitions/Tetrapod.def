java package io.tetrapod.protocol.core
java outdir "../src"
javascript out "../rsc/protocol/tetrapod.js"

// The core tetrapod service
service Tetrapod @version(1) @id(1)

error HOSTNAME_MISMATCH
error INVALID_CREDENTIALS
error INVALID_UUID

################################# STRUCTURES #################################

public struct Entity
   1: int entityId  
   2: int parentId  
   3: long reclaimToken  
   4: string host
   5: int status
   6: byte type
   7: string name
   8: int build  
   9: int version
  10: int contractId  
  
################################# REQUESTS #################################

public request Register
   1: int build
   2: string token
   3: int contractId
   4: string name
   5: int status
   6: string host

public response Register 
   1: int entityId
   2: int parentId
   3: string token

internal request IssuePeerId
   1: string host
   2: int clusterPort
   
internal response IssuePeerId
   1: int peerId   // our new peerId 
   2: int entityId // of the host we are talking to
   3: long term    // term of command that issued the peerId
   4: long index   // index of command that issued the peerId

internal request ClusterJoin
   1: int build
   2: int status
   3: string host
   4: int entityId
   5: int servicePort
   6: int clusterPort
   
internal request ClusterLeave
   1: int entityId      
   
internal request Unregister
   1: int entityId

internal request Publish 
   1: int numTopics
   error NOT_READY
   error NOT_PARENT 

internal response Publish 
   1: int[] topicIds
    
internal request RegistrySubscribe
internal request RegistryUnsubscribe
internal request ServicesSubscribe
internal request ServicesUnsubscribe

internal request ServiceStatusUpdate
   1: int status

# perhaps this should be merged into a new RegisterService   
internal request AddServiceInformation
   1: int contractId
   2: int version
   3: WebRoute[] routes
   4: StructDescription<list> structs // structs that could possibly be used in end user comms
   
internal request LogRegistryStats 

public request AdminLogin
   1: string email @sensitive
   2: string password @sensitive
   
   error INVALID_ACCOUNT         

public response AdminLogin
   2: string token @sensitive
   
public request AdminAuthorize
   1: string token @sensitive

internal request AdminCreate
   1: string token @sensitive
   2: string email @sensitive
   3: string password @sensitive
   4: long rights
   
internal request AdminDelete
   1: string token @sensitive
   2: int accountId;
   
internal request AdminChangePassword
   1: string token @sensitive
   2: string oldPassword @sensitive
   3: string newPassword @sensitive
   
internal request AdminChangeRights
   1: string token @sensitive
   2: int accountId
   3: long rights

public struct Admin
   1: int accountId
   2: string email @sensitive
   3: string hash @sensitive
   4: long rights
   5: long[] loginAttempts

   const int MAX_LOGIN_ATTEMPTS    = 5
   
   const int RIGHTS_CLUSTER_READ   = 1
   const int RIGHTS_CLUSTER_WRITE  = 2
   const int RIGHTS_USER_READ      = 4
   const int RIGHTS_USER_WRITE     = 8
   
public request KeepAlive

internal request AddWebFile
   1: string path
   2: string webRootName
   3: byte[] contents
   4: boolean clearBeforAdding 

private request SendWebRoot
   1: string webRootName
    
internal request SetAlternateId
   1: int entityId
   2: int alternateId
   
internal request GetSubscriberCount
   1: int topicId
   
internal response GetSubscriberCount
   1: int count

internal request GetEntityInfo
   1: int entityId

   error UNKNOWN_ENTITY_ID

internal response GetEntityInfo
   1: int build
   2: string name
   3: string host

################################# MESSAGES #################################

// a special message to avoid race conditions on the Register response
public message Entity 
   1: int entityId
   
// notification of an existing tetrapod cluster member    
internal message Cluster.ClusterMember
   1: int entityId
   2: string host
   3: int servicePort
   4: int clusterPort
   5: string uuid
    
##### Registry Topic Messages ##### 

internal message Registry.EntityRegistered
	1: Entity entity 
	 
internal message Registry.EntityUnregistered
	1: int entityId;
	
internal message Registry.EntityUpdated
	1: int entityId;
	2: int status;	 
	
internal message Registry.TopicPublished
   1: int ownerId
   2: int topicId

internal message Registry.TopicUnpublished
   1: int ownerId
   2: int topicId

internal message Registry.TopicSubscribed
   1: int ownerId
   2: int topicId
   3: int entityId
   4: boolean once

internal message Registry.TopicUnsubscribed
   1: int ownerId
   2: int topicId
   3: int entityId
   
internal message Registry.EntityListComplete

##### Building #############

admin request GetServiceBuildInfo
   1: int accountId
   2: string authToken @sensitive
   
admin response  GetServiceBuildInfo
   1: BuildInfo<list> services
   
// An error in any one of the build commands stops processing the remaining ones
admin request ExecuteBuildCommand
   1: int accountId
   2: string authToken @sensitive
   3: BuildCommand<list> commands

// Sent every 10s or so for display in the UI while it's running
admin message BuildCommandProgress
   1: string output
   2: boolean isDone

admin struct BuildInfo
   1: string serviceName
   2: boolean canBuild
   3: boolean canDeploy
   4: boolean canLaunch
   5: int currentBuild
   6: int[] knownBuilds

admin struct BuildCommand
   1: string serviceName
   2: int build
   3: int command
   
   const int BUILD   = 1
   const int DEPLOY  = 2
   const int LAUNCH  = 3
   const int FULL_CYCLE = 4
   const int LAUNCH_PAUSED  = 5
   
   const int DEPLOY_LATEST   = -1
   const int LAUNCH_DEPLOYED = -1

##### Services Topic Messages ##### 

internal message Services.ServiceAdded
	1: Entity entity 
	 
internal message Services.ServiceRemoved
	1: int entityId
	
internal message Services.ServiceUpdated
	1: int entityId
	2: int status
	
## 3rd party auth add-ons

internal request VerifyEntityToken
   1: int entityId
   2: string token
     

internal request RaftStats
internal response RaftStats 
   1: byte role
   2: long curTerm
   3: long lastTerm
   4: long lastIndex
   5: long commitIndex
   6: int leaderId
   7: int[] peers
      
## Cluster Properties
      
internal struct ClusterProperty
   1: string key
   2: boolean secret
   3: string val @sensitive
        
internal message  Cluster.ClusterPropertyAdded        
   1: ClusterProperty property

internal message Cluster.ClusterPropertyRemoved        
   1: string key
   
internal message Cluster.ClusterSynced      
   
internal request ClusterSubscribe
   1: string adminToken @sensitive
   
internal request SetClusterProperty
   1: string adminToken @sensitive
   2: ClusterProperty property

internal request DelClusterProperty
   1: string adminToken @sensitive
   2: string key
