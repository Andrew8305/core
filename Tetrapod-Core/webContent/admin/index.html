<!DOCTYPE html>
<html>

<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Tetrapod Admin</title>

<link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
<link rel="stylesheet" href="http://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css">

<!--  =============================================================================== -->
<style type="text/css">
#cluster-table {
	margin: 4px; padding: 12px;
}

#cluster-table th {
	background: #000; color: #fff; text-align: center;
}

#cluster-table td {
	font-size: 90%; padding: 0px 1px; vertical-align: middle; white-space: nowrap;
}

.centered {
	text-align: center;
}

.running {
	background: green; color: white;
}

.gone {
	background: red; color: white;
}

.failed {
	background: orange; color: yellow;
}

.stopping {
	background: #fdd; color: #a88;
}

.starting {
	background: #eee; color: #999;
}

.paused {
	background: yellow;
}

.dropdown-service {
	right: auto; left: 0;
}

.service-icon {
	width: 24px; height: 24px; margin-right: 8px; margin-left: 6px
}

.service-name {
	font-weight: bold;
}

.service-chart-wrap {
	position: relative; width: 80px; padding: 0px; padding-left: 0px; padding-right: 0px;
}

.service-chart {
	height: 42px; padding: 0px; margin: -5px;
}

.service-chart-val {
	text-shadow: 1px 1px 1px rgba(150, 150, 150, .5); text-align: center; position: absolute; top: 8px; left: 0; width: 100%
}

.alert {
	margin-top: 20px;
}

.dropdown-menu {
	text-align: left;
}

#page-wrapper {
	margin: 10px; padding: 10px;
}

#login-form {
	width: 320px; padding: 20px; margin: 20px; border-radius: 10px; box-shadow: 0 2px 2px rgba(0, 0, 0, .20);
}
</style>
</head>

<!--  =============================================================================== -->

<body>

	<div id="wrapper">
		<nav class="navbar navbar-default navbar-static-top" role="navigation" style="margin-bottom: 0">
			<div class="navbar-header">
				<button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".sidebar-collapse">
					<span class="fa fa-bars"></span>
				</button>
				<a class="navbar-brand" href=""> <img src="tetrapod.png"> tetrapod.io
				</a>
			</div>
			<ul class="nav navbar-top-links navbar-right">
				<li class="dropdown"><a class="dropdown-toggle" data-toggle="dropdown" href="#"> <i class="fa fa-user fa-fw"></i> <i
						class="fa fa-caret-down"></i>
				</a>
					<ul class="dropdown-menu dropdown-user">
						<li><a href="#"><i class="fa fa-gear fa-fw"></i> Settings</a></li>
						<li class="divider"></li>
						<li><a href="#" onclick="onLogout()"><i class="fa fa-sign-out fa-fw"></i> Logout</a></li>
					</ul></li>
			</ul>
		</nav>

		<div id="page-wrapper">

			<div class="row" id="login-wrapper" align="center" hidden="true">
				<div id="login-form">
					<form class="form-signin">
						<input id="email" class="form-control top" type="email" placeholder="email" required autofocus> <br /> <input
							id="password" class="form-control bottom" type="password" placeholder="password" required> <br /> <a
							class="btn btn-lg btn-block btn-primary" onclick="login()">Sign in</a>
					</form>
				</div>
			</div>

			<div class="row" id="app-wrapper" hidden="true">
				<div class="col-lg-12">
					<!--  =============================================================================== -->

					<div id="disconnected-alertbox" class="alert alert-danger" hidden="true">
						<strong>DISCONNECTED!</strong> Attempting to Reconnect...
					</div>

					<table class="table table-bordered table-condensed " id="cluster-table">
						<thead>
							<tr>
								<th><i class="fa fa-gear fa-fw"></i></th>
								<th>Name</th>
								<th>Entity</th>
								<th>Host</th>
								<th>Status</th>
								<th>Latency</th>
								<th>RPS</th>
								<th>MPS</th>
								<th>Counter</th>
							</tr>
						</thead>
						<tbody data-bind="foreach: services">
							<tr data-bind='attr: {"class": row_style}'>
								<td width="48" class="centered">
									<div class="dropdown">
										<a class="dropdown-toggle" data-toggle="dropdown" href="#"> <i class="fa fa-gear fa-fw"></i> <i
											class="fa fa-caret-down"></i>
										</a>
										<ul class="dropdown-menu dropdown-service">
											<li class="disabled"><a href="#" data-bind="text: name +' '+entityString()"></a></li>

											<!-- ko foreach: commands -->
											<li><a href="#" data-bind="click: function() { $parent.execute($data) }, text: name"></a></li>
											<!-- /ko -->

											<li class="divider"></li>

											<li><a href="#" data-bind="click: pause, visible: canPause()"><i class="fa fa-pause fa-fw"></i>Pause</a></li>
											<li><a href="#" data-bind="click: unpause, visible: canUnpause()"><i class="fa fa-play fa-fw"></i>Resume</a></li>

											<li class="divider" data-bind=" visible: !isGone()"></li>

											<li><a href="#" data-bind="click: restart, visible: !isGone()"><i class="fa fa-refresh fa-fw"></i>Restart</a></li>

											<li><a href="#" data-bind="click: shutdown, visible: !isGone()"><i class="fa fa-power-off fa-fw"></i>Shutdown</a></li>
											<li><a href="#" data-bind="click: deleteService, visible: isGone()"><i class="fa fa-trash-o fa-fw"></i>Delete</a></li>

										</ul>
									</div>
								</td>

								<td><img data-bind="attr:{src: iconURL}" class="service-icon"> <span class="service-name"
									data-bind="text: name"></span></td>
								<td class="centered"><span data-bind="text: entityString"></span></td>
								<td class="centered"><span data-bind="text: host"></span></td>
								<td data-bind="attr: {'class':status_style}"><span data-bind="text: statusName()"></span></td>
								<td class="service-chart-wrap">
									<div class="service-chart" data-bind="attr: {id: 'service-chart-latency-' + entityId}"></div> <span
									class="service-chart-val" data-bind="text: latency"></span>
								</td>
								<td class="service-chart-wrap">
									<div class="service-chart" data-bind="attr: {id: 'service-chart-rps-' + entityId}"></div> <span
									class="service-chart-val" data-bind="text: rps"></span>
								</td>
								<td class="service-chart-wrap">
									<div class="service-chart" data-bind="attr: {id: 'service-chart-mps-' + entityId}"></div> <span
									class="service-chart-val" data-bind="text: mps"></span>
								</td>
								<td class="service-chart-wrap">
									<div class="service-chart" data-bind="attr: {id: 'service-chart-counter-' + entityId}"></div> <span
									class="service-chart-val" data-bind="text: counter"></span>
								</td>
							</tr>
						</tbody>
					</table>

					<div>
						<h3>Tetrapod Platform TODOs</h3>
						<ul>
							<li>Admin accounts</li>
							<li>TLS</li>
							<li>Service Log/metrics viewing, etc...</li>
							<li>Service direct connections</li>
							<li>Tetrapod distributed locks, counters, KVStore, preferences</li>
							<li>Performance testing, queue &amp; threadpool optimizations</li>
						</ul>
					</div>
					<!--  =============================================================================== -->
				</div>
			</div>
		</div>
	</div>


	<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script>
	<script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
	<script src="//cdnjs.cloudflare.com/ajax/libs/knockout/3.1.0/knockout-min.js"></script>
	<script src="//cdnjs.cloudflare.com/ajax/libs/bootbox.js/4.2.0/bootbox.min.js"></script>
	<script src="//cdnjs.cloudflare.com/ajax/libs/flot/0.8.2/jquery.flot.min.js"></script>
	<script src="js/toolbox.js"></script>

	<script src="../protocol/server.js"></script>
	<script src="../protocol/hostname.js"></script>
	<script src="../protocol/tetrapod.js"></script>


	<script>
		var TP = new TP_Server(TP_Tetrapod);
		var Core = TP.consts["Tetrapod.Core"];
		TP.commsLog = true;
		var model = new ClusterModel();
		ko.applyBindings(model, $("#cluster-table")[0]);

		var token = null;
		var authtoken = getCookie("auth-token");

		connect();

		function connect() {
			TP.connect(new TP_Hostname().hostname, 9903).listen(onConnected,
					onDisconnected);
		}

		function onConnected() {
			$('#disconnected-alertbox').hide();
			model.services.removeAll();
			TP.send("Register", {
				build : 0,
				contractId : 0,
				name : "Web-Admin",
				token : token
			}, Core.DIRECT).handle(onRegistered);
		}

		function onDisconnected() {
			$('#disconnected-alertbox').show();
			setTimeout(function updateRandom() {
				connect();
			}, 1000);
		}

		function onRegistered(result) {
			if (!result.isError()) {
				token = result.token;
				if (authtoken != null && authtoken != "") {
					TP.send("AdminAuthorize", {
						token : authtoken
					}, Core.DIRECT).handle(onLogin);
				} else {
					onLogout()
				}
			}
		}

		function login() {
			TP.send("AdminLogin", {
				email : $('#email').val(),
				password : $('#password').val(),
			}, Core.DIRECT).handle(function(result) {
				if (result.isError()) {
					bootbox.alert('Login Failed');
				}
				onLogin(result);
			});
		}

		function onLogin(result) {
			if (!result.isError()) {
				if (result.token) {
					authtoken = result.token;
					setCookie("auth-token", authtoken);
				}
				$('#login-wrapper').hide();
				$('#app-wrapper').show();
				TP.send("ServicesSubscribe", {}, Core.DIRECT).handle(
						TP.logResponse);
			} else {
				onLogout();
			}
		}

		function onLogout() {
			authtoken = null;
			deleteCookie("auth-token");
			$('#login-wrapper').show();
			$('#app-wrapper').hide();
		}

		// Cluster Model -- list of Services
		function ClusterModel() {
			var self = this;
			self.services = ko.observableArray([]);

			// Timer to update charts
			setInterval(function updateCharts() {
				$.each(self.services(), function(i, s) {
					s.chart();
				});
			}, 1000);

			self.findService = function(entityId) {
				for (var i = 0; i < self.services().length; i++) {
					if (self.services()[i].entityId == entityId) {
						return self.services()[i];
					}
				}
				return null;
			}

			TP.addMessageHandler("ServiceAdded", function(msg) {
				var s = self.findService(msg.entity.entityId);
				if (s) {
					self.services.remove(s);
				}
				self.services.push(new Service(msg.entity));
				self.services.sort(compareServices);
			});

			TP.addMessageHandler("ServiceUpdated", function(msg) {
				var s = self.findService(msg.entityId);
				if (s) {
					s.status(msg.status);
				}
			});

			TP.addMessageHandler("ServiceRemoved", function(msg) {
				var s = self.findService(msg.entityId);
				if (s) {
					self.services.remove(s);
				}
			});

			TP.addMessageHandler("ServiceStats", function(msg) {
				var s = self.findService(msg.entityId);
				if (s) {
					s.statsUpdate(msg);
				}
			});
		}

		function compareServices(a, b) {
			return (a.entityId - b.entityId);
		}

		var chartOptions = {
			grid : {
				labelMargin : 0,
				axisMargin : 0,
				margin : {
					top : 0,
					right : 0,
					bottom : 0,
					left : 0
				},
				borderWidth : 0,
				color : "rgba(212, 212, 212, 0.25)"
			},
			xaxis : {
				show : false
			},
			yaxis : {
				show : false,
				min : 0
			},
			legend : {
				show : false,
			}
		};

		// Service Model
		function Service(entity) {
			var self = this;
			self.entityId = entity.entityId;
			self.name = entity.name;
			self.host = entity.host;
			self.status = ko.observable(entity.status);
			self.commands = ko.observableArray();
			self.mps = ko.observable();
			self.rps = ko.observable();
			self.latency = ko.observable();
			self.counter = ko.observable();

			self.iconURL = ko.observable("media/gear.gif");

			TP.send("ServiceStatsSubscribe", {}, self.entityId).handle(
					TP.logResponse)

			TP
					.send("ServiceDetails", {}, self.entityId)
					.handle(
							function(result) {
								if (!result.isError()) {
									self.iconURL(result.iconURL);
									self.metadata = result.metadata;
									if (result.commands) {
										for (var i = 0; i < result.commands.length; i++) {
											self.commands
													.push(result.commands[i]);
										}
									}
								}
							});

			self.execute = function(command) {
				TP.sendRequest(command.contractId, command.structId, {},
						self.entityId).handle(TP.logResponse)
			}

			self.entityString = ko.computed(function() {
				return self.entityId + " (0x" + self.entityId.toString(16)
						+ ")";
			});

			self.isPaused = function() {
				return (self.status() & Core.STATUS_PAUSED) != 0;
			}

			self.isGone = function() {
				return (self.status() & Core.STATUS_GONE) != 0;
			}

			self.isStarting = function() {
				return (self.status() & Core.STATUS_STARTING) != 0;
			}

			self.isFailed = function() {
				return (self.status() & Core.STATUS_FAILED) != 0;
			}

			self.isStopping = function() {
				return (self.status() & Core.STATUS_STOPPING) != 0;
			}

			self.statusName = ko.computed(function() {
				if (self.isGone())
					return "GONE";
				if (self.isStopping())
					return "STOPPING";
				if (self.isFailed())
					return "FAILED";
				if (self.isPaused())
					return "PAUSED";
				if (self.isStarting())
					return "STARTING";
				return "RUNNING";
			});

			self.row_style = ko.computed(function() {
				if (self.isStopping())
					return "stopping";
				if (self.isPaused())
					return "paused";
				if (self.isStarting())
					return "starting";
				return "";
			});

			self.status_style = ko.computed(function() {
				return self.statusName().toLowerCase() + " centered";
			});

			self.pause = function() {
				TP.send("Pause", {}, self.entityId);
			}

			self.unpause = function() {
				TP.send("Unpause", {}, self.entityId);
			}
			self.restart = function() {
				bootbox.confirm("Are you sure you want to restart service: "
						+ self.name + "[" + self.entitId + "]?", function(
						result) {
					if (result) {
						TP.send("Restart", {}, self.entityId);
					}
				});
			}
			self.shutdown = function() {
				bootbox.confirm("Are you sure you want to shutdown service: "
						+ self.name + "[" + self.entitId + "]?", function(
						result) {
					if (result) {
						TP.send("Shutdown", {}, self.entityId);
					}
				});
			}

			self.deleteService = function() {
				TP.send("Unregister", {
					entityId : self.entityId
				}, Core.DIRECT);
			}

			self.canPause = function() {
				return !self.isGone() && !self.isPaused();
			}

			self.canUnpause = function() {
				return !self.isGone() && self.isPaused();
			}

			self.statsUpdate = function(msg) {
				self.latency(msg.latency);
				self.rps(msg.rps);
				self.mps(msg.mps);
				self.counter(msg.counter);
			}

			//////////////////////////////////////// stats graphs ////////////////////////////////////////
			self.plots = [];
			self.getPlot = function(tag) {
				if (self.plots[tag]) {
					return self.plots[tag];
				}
				var container = $("#service-chart-" + tag + "-" + self.entityId);
				if (!container)
					return;

				return $.plot(container, [], chartOptions);
			}

			self.updatePlot = function(tag, series, timeRange, value) {
				series.data.push([ Date.now(), value ]);
				while (series.data[0][0] < Date.now() - timeRange) {
					series.data.shift();
				}
				if (series.maxY != 0) {
					chartOptions.yaxis.max = series.maxY;
				} else {
					chartOptions.yaxis.max = null;
				}
				plot = self.getPlot(tag);
				if (plot) {
					plot.setData([ series ]);
					plot.setupGrid();
					plot.draw();
				}
			}

			self.latencySeries = {
				data : [],
				maxY : 500,
				lines : {
					lineWidth : 1,
					fill : true
				},
				shadowSize : 1
			};
			self.rpsSeries = {
				data : [],
				lines : {
					lineWidth : 1,
					fill : true
				},
				shadowSize : 1
			};
			self.mpsSeries = {
				data : [],
				lines : {
					lineWidth : 1,
					fill : true
				},
				shadowSize : 1
			};
			self.counterSeries = {
				data : [],
				lines : {
					lineWidth : 1,
					fill : true
				},
				shadowSize : 1
			};
			// updates all charts for this service
			self.chart = function() {
				self.updatePlot("latency", self.latencySeries, 60000, self
						.latency());
				self.updatePlot("rps", self.rpsSeries, 60000, self.rps());
				self.updatePlot("mps", self.mpsSeries, 60000, self.mps());
				self.updatePlot("counter", self.counterSeries, 60000, self
						.counter());
			}

		}
	</script>

	<!--  =============================================================================== -->

</body>

</html>
